# Database Setup (Code Relay)

## Target DB Dialect

The optimized script targets **PostgreSQL**.

- Primary script: `FULL_WORKING_PROJECT/DATABASE/CODE_RELLAY.optimized.sql`
- Legacy/original script remains at: `FULL_WORKING_PROJECT/DATABASE/CODE_RELLAY.sql`

## How to Run

### 1) Create or choose a database

```sql
CREATE DATABASE code_relay;
```

### 2) Execute schema script

From shell:

```bash
psql -d code_relay -f FULL_WORKING_PROJECT/DATABASE/CODE_RELLAY.optimized.sql
```

Or inside `psql`:

```sql
\i FULL_WORKING_PROJECT/DATABASE/CODE_RELLAY.optimized.sql
```

## Notes on Re-runnability

The optimized script is re-runnable because it:

- Drops tables in dependency-safe order using `DROP TABLE IF EXISTS`
- Recreates all schema objects in one transactional run (`BEGIN ... COMMIT`)

## ER Summary

### Tables and keys

- `users` (`id` PK, `email` UNIQUE)
- `workspaces` (`id` PK, `created_by` FK -> `users.id`)
- `memberships` (`id` PK, `user_id` FK -> `users.id`, `workspace_id` FK -> `workspaces.id`, UNIQUE(`user_id`, `workspace_id`))
- `articles` (`id` PK, `workspace_id` FK -> `workspaces.id`, `created_by` FK -> `users.id`)
- `article_versions` (`id` PK, `article_id` FK -> `articles.id`, `created_by` FK -> `users.id`, UNIQUE(`article_id`, `version_number`))
- `tags` (`id` PK, `workspace_id` FK -> `workspaces.id`, UNIQUE(`workspace_id`, `name`))
- `article_tags` (composite PK: `article_id`, `tag_id`; FKs to `articles.id` and `tags.id`)
- `conversations` (`id` PK, `workspace_id` FK -> `workspaces.id`, `created_by` FK -> `users.id`)
- `messages` (`id` PK, `conversation_id` FK -> `conversations.id`, `sender_id` FK -> `users.id`, `parent_message_id` self-FK -> `messages.id`)

### Relationship summary

- One user creates many workspaces.
- Users and workspaces are many-to-many through memberships.
- One workspace has many articles, tags, and conversations.
- One article has many article versions.
- Articles and tags are many-to-many through `article_tags`.
- One conversation has many messages.
- Messages support threaded replies via self-reference (`parent_message_id`).

## Portability Notes

The script is PostgreSQL-compatible and mostly ANSI-oriented, but these features are PostgreSQL-specific:

- `BIGSERIAL` auto-increment keys
- `tsvector`, `to_tsvector`, `to_tsquery`, `ts_rank`
- GIN indexes and `plpgsql` trigger functions

For stricter ANSI portability:

- Replace `BIGSERIAL` with `BIGINT GENERATED BY DEFAULT AS IDENTITY` where supported.
- Remove full-text search objects or replace with vendor-native equivalents.
